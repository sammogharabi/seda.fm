import React, { useState } from 'react';
import { Button } from './ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from './ui/dialog';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator, DropdownMenuTrigger } from './ui/dropdown-menu';
import { Alert, AlertDescription } from './ui/alert';
import { 
  MoreHorizontal,\n  Play,\n  Share,\n  Edit3,\n  Trash2,\n  Download,\n  ExternalLink,\n  Copy,\n  Users,\n  ListMusic,\n  AlertTriangle\n} from 'lucide-react';\nimport { toast } from 'sonner';\n\ninterface Track {\n  id: string | number;\n  title: string;\n  artist: string;\n  duration?: string;\n  artwork?: string;\n  provider?: string;\n  addedBy?: {\n    username: string;\n    avatar: string;\n  };\n}\n\ninterface Playlist {\n  id: number;\n  name: string;\n  description?: string;\n  isPublic: boolean;\n  isCollaborative: boolean;\n  trackCount: number;\n  duration?: string;\n  owner: {\n    username: string;\n    avatar: string;\n    verified?: boolean;\n  };\n  tracks: Track[];\n}\n\ninterface PlaylistActionsProps {\n  playlist: Playlist;\n  currentUser: {\n    username: string;\n    avatar: string;\n  };\n  onEdit?: (playlist: Playlist) => void;\n  onDelete?: (playlistId: number) => void;\n  onShare?: (playlist: Playlist) => void;\n  onExport?: (playlist: Playlist) => void;\n  onAddToQueue?: (tracks: Track[]) => void;\n  selectedTracks?: Set<string | number>;\n  onBulkOperation?: (operation: string, trackIds: (string | number)[]) => void;\n}\n\nexport function PlaylistActions({\n  playlist,\n  currentUser,\n  onEdit,\n  onDelete,\n  onShare,\n  onExport,\n  onAddToQueue,\n  selectedTracks = new Set(),\n  onBulkOperation\n}: PlaylistActionsProps) {\n  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);\n  const [showBulkActions, setShowBulkActions] = useState(false);\n\n  const canEdit = playlist.owner.username === currentUser.username || playlist.isCollaborative;\n  const canDelete = playlist.owner.username === currentUser.username;\n  const hasSelectedTracks = selectedTracks.size > 0;\n\n  const handleShare = () => {\n    const shareUrl = `https://seda.fm/playlist/${playlist.id}`;\n    navigator.clipboard.writeText(shareUrl);\n    toast.success('Playlist link copied to clipboard!');\n    if (onShare) onShare(playlist);\n  };\n\n  const handleExport = () => {\n    // Mock export functionality\n    if (onExport) {\n      onExport(playlist);\n    } else {\n      // Generate a simple text export\n      const exportText = [\n        `Playlist: ${playlist.name}`,\n        `Description: ${playlist.description || 'No description'}`,\n        `Tracks (${playlist.trackCount}):`,\n        '',\n        ...playlist.tracks.map((track, index) => \n          `${index + 1}. ${track.title} - ${track.artist} (${track.duration || 'Unknown'})`\n        )\n      ].join('\\n');\n\n      const blob = new Blob([exportText], { type: 'text/plain' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `${playlist.name.replace(/[^a-z0-9]/gi, '_')}.txt`;\n      a.click();\n      URL.revokeObjectURL(url);\n      \n      toast.success('Playlist exported as text file!');\n    }\n  };\n\n  const handleDelete = () => {\n    if (onDelete) {\n      onDelete(playlist.id);\n      setShowDeleteConfirm(false);\n      toast.success('Playlist deleted!');\n    }\n  };\n\n  const handleBulkOperation = (operation: string) => {\n    if (!onBulkOperation) return;\n    \n    const trackIds = Array.from(selectedTracks);\n    onBulkOperation(operation, trackIds);\n    \n    switch (operation) {\n      case 'remove':\n        toast.success(`${trackIds.length} track${trackIds.length > 1 ? 's' : ''} removed from playlist`);\n        break;\n      case 'addToQueue':\n        const selectedTrackObjs = playlist.tracks.filter(track => selectedTracks.has(track.id));\n        if (onAddToQueue) onAddToQueue(selectedTrackObjs);\n        toast.success(`${trackIds.length} track${trackIds.length > 1 ? 's' : ''} added to DJ queue`);\n        break;\n      case 'export':\n        const exportTracks = playlist.tracks.filter(track => selectedTracks.has(track.id));\n        const exportText = exportTracks.map((track, index) => \n          `${index + 1}. ${track.title} - ${track.artist} (${track.duration || 'Unknown'})`\n        ).join('\\n');\n        \n        const blob = new Blob([exportText], { type: 'text/plain' });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `${playlist.name}_selected_tracks.txt`;\n        a.click();\n        URL.revokeObjectURL(url);\n        \n        toast.success('Selected tracks exported!');\n        break;\n    }\n    \n    setShowBulkActions(false);\n  };\n\n  const openInSpotify = () => {\n    // Mock Spotify integration\n    window.open(`https://open.spotify.com/playlist/${playlist.id}`, '_blank');\n    toast.info('Opening in Spotify...');\n  };\n\n  const openInAppleMusic = () => {\n    // Mock Apple Music integration\n    window.open(`https://music.apple.com/playlist/${playlist.id}`, '_blank');\n    toast.info('Opening in Apple Music...');\n  };\n\n  const copyPlaylistData = () => {\n    const playlistData = {\n      name: playlist.name,\n      description: playlist.description,\n      tracks: playlist.tracks.map(track => ({\n        title: track.title,\n        artist: track.artist,\n        duration: track.duration\n      }))\n    };\n    \n    navigator.clipboard.writeText(JSON.stringify(playlistData, null, 2));\n    toast.success('Playlist data copied to clipboard!');\n  };\n\n  return (\n    <>\n      {/* Main Actions Dropdown */}\n      <DropdownMenu>\n        <DropdownMenuTrigger asChild>\n          <Button variant=\"ghost\" size=\"sm\">\n            <MoreHorizontal className=\"w-4 h-4\" />\n          </Button>\n        </DropdownMenuTrigger>\n        <DropdownMenuContent align=\"end\" className=\"w-48\">\n          <DropdownMenuItem onClick={() => onAddToQueue && onAddToQueue(playlist.tracks)}>\n            <Play className=\"w-4 h-4 mr-2\" />\n            Play All in DJ Mode\n          </DropdownMenuItem>\n          \n          <DropdownMenuItem onClick={handleShare}>\n            <Share className=\"w-4 h-4 mr-2\" />\n            Share Playlist\n          </DropdownMenuItem>\n\n          {canEdit && (\n            <DropdownMenuItem onClick={() => onEdit && onEdit(playlist)}>\n              <Edit3 className=\"w-4 h-4 mr-2\" />\n              Edit Playlist\n            </DropdownMenuItem>\n          )}\n\n          <DropdownMenuSeparator />\n\n          <DropdownMenuItem onClick={handleExport}>\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export as Text\n          </DropdownMenuItem>\n\n          <DropdownMenuItem onClick={copyPlaylistData}>\n            <Copy className=\"w-4 h-4 mr-2\" />\n            Copy Playlist Data\n          </DropdownMenuItem>\n\n          <DropdownMenuSeparator />\n\n          <DropdownMenuItem onClick={openInSpotify}>\n            <ExternalLink className=\"w-4 h-4 mr-2\" />\n            Open in Spotify\n          </DropdownMenuItem>\n\n          <DropdownMenuItem onClick={openInAppleMusic}>\n            <ExternalLink className=\"w-4 h-4 mr-2\" />\n            Open in Apple Music\n          </DropdownMenuItem>\n\n          {hasSelectedTracks && (\n            <>\n              <DropdownMenuSeparator />\n              <DropdownMenuItem onClick={() => setShowBulkActions(true)}>\n                <ListMusic className=\"w-4 h-4 mr-2\" />\n                Bulk Actions ({selectedTracks.size})\n              </DropdownMenuItem>\n            </>\n          )}\n\n          {canDelete && (\n            <>\n              <DropdownMenuSeparator />\n              <DropdownMenuItem \n                onClick={() => setShowDeleteConfirm(true)}\n                className=\"text-red-600 focus:text-red-600\"\n              >\n                <Trash2 className=\"w-4 h-4 mr-2\" />\n                Delete Playlist\n              </DropdownMenuItem>\n            </>\n          )}\n        </DropdownMenuContent>\n      </DropdownMenu>\n\n      {/* Bulk Actions Dialog */}\n      <Dialog open={showBulkActions} onOpenChange={setShowBulkActions}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Bulk Actions</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              {selectedTracks.size} track{selectedTracks.size > 1 ? 's' : ''} selected\n            </p>\n            \n            <div className=\"space-y-2\">\n              <Button \n                onClick={() => handleBulkOperation('addToQueue')} \n                className=\"w-full justify-start\"\n                variant=\"outline\"\n              >\n                <Play className=\"w-4 h-4 mr-2\" />\n                Add Selected to DJ Queue\n              </Button>\n              \n              <Button \n                onClick={() => handleBulkOperation('export')} \n                className=\"w-full justify-start\"\n                variant=\"outline\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                Export Selected Tracks\n              </Button>\n              \n              {canEdit && (\n                <Button \n                  onClick={() => handleBulkOperation('remove')} \n                  className=\"w-full justify-start\"\n                  variant=\"outline\"\n                >\n                  <Trash2 className=\"w-4 h-4 mr-2\" />\n                  Remove Selected from Playlist\n                </Button>\n              )}\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={showDeleteConfirm} onOpenChange={setShowDeleteConfirm}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Playlist</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <Alert>\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertDescription>\n                This action cannot be undone. This will permanently delete the playlist \n                \"{playlist.name}\" and remove all {playlist.trackCount} tracks from it.\n                {playlist.isPublic && (\n                  <span className=\"block mt-2 font-medium\">\n                    This public playlist may have followers who will lose access.\n                  </span>\n                )}\n              </AlertDescription>\n            </Alert>\n            \n            <div className=\"flex gap-2\">\n              <Button \n                variant=\"destructive\" \n                onClick={handleDelete}\n                className=\"flex-1\"\n              >\n                Delete Playlist\n              </Button>\n              <Button \n                variant=\"outline\" \n                onClick={() => setShowDeleteConfirm(false)}\n                className=\"flex-1\"\n              >\n                Cancel\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n\n// Quick action buttons for common operations\nexport function QuickPlaylistActions({\n  playlist,\n  currentUser,\n  onShare,\n  onAddToQueue\n}: Pick<PlaylistActionsProps, 'playlist' | 'currentUser' | 'onShare' | 'onAddToQueue'>) {\n  const handleShare = () => {\n    const shareUrl = `https://seda.fm/playlist/${playlist.id}`;\n    navigator.clipboard.writeText(shareUrl);\n    toast.success('Playlist link copied!');\n    if (onShare) onShare(playlist);\n  };\n\n  return (\n    <div className=\"flex gap-1\">\n      <Button \n        size=\"sm\" \n        variant=\"ghost\" \n        onClick={() => onAddToQueue && onAddToQueue(playlist.tracks)}\n        title=\"Add all tracks to DJ queue\"\n      >\n        <Play className=\"w-4 h-4\" />\n      </Button>\n      \n      <Button \n        size=\"sm\" \n        variant=\"ghost\" \n        onClick={handleShare}\n        title=\"Share playlist\"\n      >\n        <Share className=\"w-4 h-4\" />\n      </Button>\n    </div>\n  );\n}